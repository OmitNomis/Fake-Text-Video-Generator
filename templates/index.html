<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fake Text Story Video Generator</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/imessage.css') }}?v={{ range(1, 999999) | random }}" type="text/css">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/modal.css') }}?v={{ range(1, 999999) | random }}" type="text/css">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
</head>
<body>
    <div id="loadingOverlay" class="loading-overlay" style="display: none;">
        <div class="loading-content">
            <div class="loader"></div>
            <h2>Generating Your Video</h2>
            <div class="progress-container">
                <div class="progress-bar" id="progressBar"></div>
                <div class="progress-text" id="progressText">0%</div>
            </div>
            <div id="generationLog" class="generation-log">
                <div class="log-content"></div>
            </div>
        </div>
    </div>
    <div id="profileImageModal" class="modal picture-modal">
        <div class="modal-content picture-modal-content">
            <span class="close picture-modal-close">&times;</span>
            <h2>Choose Profile Picture</h2>
            <div class="profile-sections">
                <div class="upload-section">
                    <h3>Upload New Image</h3>
                    <div class="upload-preview-container">
                        <img id="uploadPreview" src="#" alt="Preview" style="display: none;">
                        <div class="upload-controls">
                            <input type="file" id="profileUpload" accept="image/*,.webp" multiple="false">
                            <button id="uploadBtn" disabled>Upload</button>
                        </div>
                    </div>
                </div>
                <div class="existing-section">
                    <h3>Existing Images</h3>
                    <div id="existingImages" class="image-grid">
                        <!-- Existing images will be loaded here -->
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="stars">
        <div class="star"></div>
        <div class="star"></div>
        <div class="star"></div>
        <div class="star"></div>
        <div class="star"></div>
        <div class="star"></div>
        <div class="star"></div>
        <div class="star"></div>
    </div>
    <div class="page-container">
        <!-- Guide Section -->
        <div class="guide-section">
            <h1>Fake Text Story Video Generator</h1>
            <p>Welcome to GoViral Wizard's Text Story Generator! Create engaging text message videos with realistic conversations.</p>
            
            <p>With our generator, you can:</p>
            <ul>
                <li>Create messages for both sender and receiver</li>
                <li>Edit messages freely at any time</li>
                <li>Add fun sound effects to individual messages</li>
                <li>Choose from various voice actors for both participants</li>
                <li>Select your preferred background video style</li>
            </ul>
            
            <p><strong>Important:</strong> To use voice features, you'll need an ElevenLabs account. Enter your API key and ensure you have the "Adam" and "Natalie" voices added to your voice library.</p>
            
            <p>Ready to create your viral text story? Start typing your messages and let your creativity flow!</p>
        </div>

        <!-- Chat Section -->
        <div class="chat-section">
            <div class="container" id="chatContainer">
                <div class="header">
                    <div class="header-left">
                        <div class="back-button">‹</div>
                    </div>
                    <div class="header-center">
                        <div class="profile-image" id="profileImageContainer">
                            <img src="{{ url_for('static', filename='images/profile.jpg') }}" alt="Profile" id="profileImage">
                            <input type="file" id="profileUpload" accept="image/*" style="display: none;">
                        </div>
                        <div class="header-text" id="headerName" contenteditable="true" spellcheck="false">
                            John Doe
                        </div>
                    </div>
                    <div class="header-right">
                    </div>
                </div>
                <div class="message-container" id="messageContainer">
                    <div class="dynamic-container">
                        <!-- Messages will be added here -->
                    </div>
                </div>
                <div class="input-area">
                    <div class="imessage-input">
                        <input type="text" id="messageInput" placeholder="iMessage">
                        <button id="senderToggle">⇄</button>
                        <button id="addMessage">Send</button>
                    </div>
                    <div class="button-group">
                        <button class="generate-button" id="generateBtn">Generate Video</button>
                        <button class="import-button" id="importBtn">Import JSON</button>
                    </div>
                </div>
            </div>
            
            <!-- Settings wrapper -->
            <div class="settings-wrapper">
                <div class="voice-settings">
                    <h3>Choose Voice Actors</h3>
                    <div class="api-key-section">
                        <input type="text" id="elevenLabsKey" placeholder="Enter ElevenLabs API Key" class="api-key-input">
                        <button onclick="fetchVoiceIds()" class="fetch-voices-btn">Fetch Voices</button>
                    </div>
                    <div class="voice-selector-container">
                        <div class="voice-selector">
                            <label for="senderVoice">Sender Voice:</label>
                            <select id="senderVoice">
                                <option value="">Select a voice</option>
                            </select>
                        </div>
                        <div class="voice-selector">
                            <label for="receiverVoice">Receiver Voice:</label>
                            <select id="receiverVoice">
                                <option value="">Select a voice</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="video-selection">
                    <h3>Select Background Video</h3>
                    <div class="video-previews" id="videoPreviewsContainer">
                        <!-- Videos will be dynamically added here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Add this after the chat-section div -->
        <div class="steps-guide">
            <h2>How to Use</h2>
            <div class="step">
                <div class="step-number">1</div>
                <p>Type your message in the input box and press Enter or click Send</p>
            </div>
            <div class="step">
                <div class="step-number">2</div>
                <p>Click on any message to edit, add sound effects, or manage message options</p>
            </div>
            <div class="step">
                <div class="step-number">3</div>
                <p>Click on profile image to upload your own profile image. Click on header name to edit your name.</p>
            </div>
            <div class="step">
                <div class="step-number">4</div>
                <p>Enter your ElevenLabs API key and click "Fetch Voices" to set up voice actors</p>
            </div>
            <div class="step">
                <div class="step-number">5</div>
                <p>Select voice actors for both sender and receiver</p>
            </div>
            <div class="step">
                <div class="step-number">6</div>
                <p>Choose your preferred background video style</p>
            </div>
            <div class="step">
                <div class="step-number">7</div>
                <p>Click "Generate Video" to create your text message video</p>
            </div>
        </div>
    </div>

    <!-- Add modal for JSON import -->
    <div id="importJsonModal" class="modal json-import-modal">
        <div class="modal-content json-import-modal-content">
            <span class="close json-import-modal-close">&times;</span>
            <h2>Import Conversation</h2>
            <div class="sample-json">
                Sample Format:
                <pre>
                    [
                        {
                            "id": 1234567890,
                            "text": "Hey, how are you?",
                            "is_sender": true,
                            "soundEffect": "notification"
                        },
                        {
                            "id": 1234567891,
                            "text": "I'm good, thanks!",
                            "is_sender": false,
                            "soundEffect": null
                        }
                    ]
                </pre>
            </div>
            <textarea id="jsonInput" spellcheck="false" placeholder="Paste your JSON data here"></textarea>
            <button id="confirmImport">Import Conversation</button>
        </div>
    </div>

    <style>
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }

        .loading-content {
            text-align: center;
            color: white;
            width: 90%;
            max-width: 600px;
            height: 80vh;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .loader {
            width: 60px;
            height: 60px;
            border: 5px solid #1a1a1a;
            border-radius: 50%;
            border-top: 5px solid #3498db;
            margin: 0 auto;
            animation: spin 1s linear infinite;
        }

        .progress-container {
            width: 100%;
            height: 20px;
            background: #1a1a1a;
            border-radius: 10px;
            overflow: hidden;
            position: relative;
        }

        .progress-bar {
            width: 0%;
            height: 100%;
            background: linear-gradient(90deg, #3498db, #2ecc71);
            transition: width 0.3s ease;
        }

        .progress-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-weight: bold;
        }

        .generation-log {
            flex-grow: 1;
            background: #1a1a1a;
            border-radius: 10px;
            padding: 15px;
            position: relative;
            overflow: hidden;
        }

        .log-content {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            max-height: 100%;
            overflow-y: auto;
            padding: 15px;
            font-family: 'Courier New', monospace;
            text-align: left;
            display: flex;
            flex-direction: column;
        }

        .log-entry {
            margin: 5px 0;
            font-size: 14px;
            line-height: 1.4;
        }

        .log-entry.info { color: #3498db; }
        .log-entry.success { color: #2ecc71; }
        .log-entry.warning { color: #f1c40f; }
        .log-entry.error { color: #e74c3c; }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>

    <script>
        let messages = [];
        let isSender = true;
        let isGenerating = false;

        const messageInput = document.getElementById('messageInput');
        const messageContainer = document.getElementById('messageContainer');
        const chatContainer = document.getElementById('chatContainer');
        const senderToggle = document.getElementById('senderToggle');
        const addMessageBtn = document.getElementById('addMessage');
        const generateBtn = document.getElementById('generateBtn');

        function scrollToBottom() {
            messageContainer.scrollTop = messageContainer.scrollHeight;
        }

        // Function to update messages array and ensure synchronization
        function updateMessagesArray() {
            const dynamicContainer = document.querySelector('.dynamic-container');
            messages = Array.from(dynamicContainer.children).map(messageDiv => ({
                id: messageDiv.getAttribute('data-id') || Date.now(),
                text: messageDiv.textContent.trim(),
                is_sender: messageDiv.classList.contains('sender'),
                soundEffect: messageDiv.getAttribute('data-sound-effect') || null // Preserve sound effect
            })).filter(msg => msg.text);
            
            console.log('Updated messages array:', messages);
        }

        function importFromJSON(json){
            if (!json) return;
            
            try {
                const data = JSON.parse(json);
                if (!Array.isArray(data)) {
                    throw new Error('Invalid JSON data');
                }
                
                // Clear existing messages
                const dynamicContainer = document.querySelector('.dynamic-container');
                dynamicContainer.innerHTML = '';
                
                // Add new messages
                data.forEach(msg => {
                    const messageDiv = document.createElement('div');
                    messageDiv.className = `message ${msg.is_sender ? 'sender' : 'receiver'}`;
                    messageDiv.textContent = msg.text;
                    messageDiv.setAttribute('data-id', msg.id);
                    messageDiv.setAttribute('data-sound-effect', msg.soundEffect || '');
                    dynamicContainer.appendChild(messageDiv);
                });
                
                updateMessagesArray();  // Update messages array after importing
                scrollToBottom();
            } catch (error) {
                console.error('Error importing JSON:', error);
                alert('Failed to import JSON data. Please check the format.');
            }
        }

        // Modify addMessage function
        function addMessage() {
            const text = messageInput.value.trim();
            if (!text) return;

            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${isSender ? 'sender' : 'receiver'}`;
            messageDiv.textContent = text;
            messageDiv.setAttribute('data-id', Date.now());

            // find out if it is the first message
            const isFirstMessage = messageContainer.querySelector('.dynamic-container').children.length === 0;
            if (isSender){
                messageDiv.setAttribute('data-sound-effect', 'send');
            } else {
                if (isFirstMessage){
                    messageDiv.setAttribute('data-sound-effect', 'notification');
                } else {
                    messageDiv.setAttribute('data-sound-effect', 'receive');
                }
            }
            
            const dynamicContainer = document.querySelector('.dynamic-container');
            dynamicContainer.appendChild(messageDiv);

            updateMessagesArray(); // Update messages array after adding
            
            messageInput.value = '';
            messageInput.focus();
            scrollToBottom();
        }

        messageInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') addMessage();
        });

        senderToggle.addEventListener('click', () => {
            isSender = !isSender;
            senderToggle.classList.toggle('receiver');
        });

        addMessageBtn.addEventListener('click', addMessage);
        generateBtn.addEventListener('click', async () => {
            if (isGenerating) return;
            isGenerating = true;
            generateBtn.textContent = 'Generating...';
            
            const loadingOverlay = document.getElementById('loadingOverlay');
            loadingOverlay.style.display = 'flex';
            updateProgress(0);
            
            try {
                updateMessagesArray();
                addLog('Starting video generation...', 'info');
                updateProgress(5);
                
                addLog('Processing messages and preparing audio generation...', 'info');
                updateProgress(10);
                
                const requestData = {
                    messages: messages,
                    profileImage: localStorage.getItem('profileImage') || '',
                    headerName: localStorage.getItem('headerName') || 'John Doe',
                    voiceSettings: {
                        apiKey: document.getElementById('elevenLabsKey').value,
                        sender: document.getElementById('senderVoice').value,  // This will now be the voice ID
                        receiver: document.getElementById('receiverVoice').value  // This will now be the voice ID
                    },
                    backgroundVideo: document.querySelector('input[name="background"]:checked').value
                };
                
                let messageCount = messages.length;
                let progressPerMessage = 70 / messageCount; // Reserve 70% for message processing
                
                messages.forEach((msg, index) => {
                    addLog(`Generating audio for message ${index + 1}/${messageCount}: "${msg.text.substring(0, 30)}${msg.text.length > 30 ? '...' : ''}"`, 'info');
                    updateProgress(10 + (progressPerMessage * (index + 1)));
                });
                
                addLog('Starting video rendering...', 'info');
                updateProgress(80);
                
                const response = await fetch('/api/generate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestData)
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Video generation failed');
                }
                
                const data = await response.json();
                updateProgress(100);
                addLog('Video generated successfully!', 'success');
                
                // Create download link
                const a = document.createElement('a');
                a.href = data.video_url;
                a.download = data.video_url.split('/').pop();
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                
            } catch (error) {
                console.error('Error:', error);
                addLog(`Error: ${error.message}`, 'error');
                alert('Failed to generate video: ' + error.message);
            } finally {
                setTimeout(() => {
                    loadingOverlay.style.display = 'none';
                    generateBtn.textContent = 'Generate Video';
                    isGenerating = false;
                }, 2000);
            }
        });
        
        // Initialize scroll position when page loads
        window.addEventListener('load', scrollToBottom);

        // Message editing functionality
        let currentOptionsMenu = null;

        function createOptionsMenu() {
            const menu = document.createElement('div');
            menu.className = 'message-options';
            menu.innerHTML = `
                <button class="edit">Edit</button>
                <button class="switch">Switch Side</button>
                <button class="add-textbox-above">Add Textbox Above</button>
                <button class="add-textbox-below">Add Textbox Below</button>
                <button class="sound-effect">Sound Effects</button>
                <button class="delete">Delete</button>
            `;
            return menu;
        }

        function hideOptionsMenu() {
            if (currentOptionsMenu) {
                currentOptionsMenu.style.display = 'none';
            }
        }

        function handleMessageClick(e) {
            const messageDiv = e.target.closest('.message');
            if (!messageDiv) return;

            hideOptionsMenu();

            // Create new options menu
            const optionsMenu = createOptionsMenu();
            document.body.appendChild(optionsMenu);  // Append to body instead of messageContainer
            currentOptionsMenu = optionsMenu;

            // Position the menu relative to the viewport
            const rect = messageDiv.getBoundingClientRect();
            
            optionsMenu.style.position = 'fixed';  // Use fixed positioning
            optionsMenu.style.display = 'block';
            
            // Position menu below the message
            optionsMenu.style.top = `${rect.bottom}px`;
            
            // Horizontal positioning
            if (messageDiv.classList.contains('sender')) {
                optionsMenu.style.right = `${window.innerWidth - rect.right}px`;
                optionsMenu.style.left = 'auto';
            } else {
                optionsMenu.style.left = `${rect.left}px`;
                optionsMenu.style.right = 'auto';
            }

            // Handle options
            optionsMenu.querySelector('.edit').onclick = (e) => {
                e.stopPropagation();
                messageDiv.contentEditable = true;
                messageDiv.focus();
                hideOptionsMenu();
                
                messageDiv.addEventListener('input', () => {
                    updateMessagesArray();
                });
                
                messageDiv.onblur = () => {
                    messageDiv.contentEditable = false;
                    updateMessagesArray();
                };
            };

            optionsMenu.querySelector('.switch').onclick = (e) => {
                e.stopPropagation();
                const isSenderMessage = messageDiv.classList.contains('sender');
                messageDiv.classList.toggle('sender');
                messageDiv.classList.toggle('receiver');

                const isFirstMessage = messageDiv.parentNode.querySelector('.message') === messageDiv;
                if (isSenderMessage){
                    messageDiv.setAttribute('data-sound-effect', isFirstMessage ? 'notification' : 'receive');
                } else {
                    messageDiv.setAttribute('data-sound-effect', 'send');
                }
                
                const index = Array.from(messageDiv.parentNode.children).indexOf(messageDiv);
                if (index !== -1 && messages[index]) {
                    messages[index].is_sender = !isSenderMessage;
                }
                hideOptionsMenu();
            };

            optionsMenu.querySelector('.add-textbox-above').onclick = (e) => {
                e.stopPropagation();
                const newMessage = document.createElement('div');
                const messageId = Date.now();
                newMessage.className = `message ${messageDiv.classList.contains('sender') ? 'sender' : 'receiver'}`;
                newMessage.setAttribute('data-id', messageId);
                messageDiv.parentNode.insertBefore(newMessage, messageDiv);
                
                newMessage.contentEditable = true;
                newMessage.focus();
                
                newMessage.addEventListener('input', () => {
                    updateMessagesArray();
                });
                
                newMessage.onblur = () => {
                    newMessage.contentEditable = false;
                    if (!newMessage.textContent.trim()) {
                        newMessage.remove();
                    }
                    updateMessagesArray();
                };
                
                hideOptionsMenu();
            };

            optionsMenu.querySelector('.add-textbox-below').onclick = (e) => {
                e.stopPropagation();
                const newMessage = document.createElement('div');
                const messageId = Date.now();
                newMessage.className = `message ${messageDiv.classList.contains('sender') ? 'sender' : 'receiver'}`;
                newMessage.setAttribute('data-id', messageId);
                
                if (messageDiv.nextSibling) {
                    messageDiv.parentNode.insertBefore(newMessage, messageDiv.nextSibling);
                } else {
                    messageDiv.parentNode.appendChild(newMessage);
                }
                
                newMessage.contentEditable = true;
                newMessage.focus();
                
                newMessage.addEventListener('input', () => {
                    updateMessagesArray();
                });
                
                newMessage.onblur = () => {
                    newMessage.contentEditable = false;
                    if (!newMessage.textContent.trim()) {
                        newMessage.remove();
                    }
                    updateMessagesArray();
                };
                
                hideOptionsMenu();
            };

            optionsMenu.querySelector('.sound-effect').onclick = (e) => {
                e.stopPropagation();
                
                const existingSubmenu = document.querySelector('.sound-effect-submenu');
                if (existingSubmenu) existingSubmenu.remove();
                
                const submenu = createSoundEffectSubmenu(messageDiv);
                document.body.appendChild(submenu);  // Append to body instead of messageContainer
                
                const buttonRect = e.target.getBoundingClientRect();
                
                submenu.style.position = 'fixed';  // Use fixed positioning
                submenu.style.left = `${buttonRect.right}px`;
                submenu.style.top = `${buttonRect.top}px`;
                
                submenu.querySelectorAll('.effect-option').forEach(option => {
                    option.onclick = (event) => {
                        event.stopPropagation();
                        const selectedEffect = event.target.dataset.effect;
                        
                        // Update the DOM element with the sound effect
                        messageDiv.setAttribute('data-sound-effect', selectedEffect === 'none' ? '' : selectedEffect);
                        
                        // Update the messages array
                        updateMessagesArray();
                        
                        // Update checkmarks in real-time
                        submenu.querySelectorAll('.effect-option').forEach(opt => {
                            opt.textContent = `${opt.dataset.effect.charAt(0).toUpperCase() + 
                                opt.dataset.effect.slice(1)} ${opt.dataset.effect === selectedEffect ? '✓' : ''}`;
                        });
                    };
                });
                
                document.addEventListener('click', function closeSubmenu(event) {
                    if (!submenu.contains(event.target) && !e.target.contains(event.target)) {
                        submenu.remove();
                        hideOptionsMenu();
                        document.removeEventListener('click', closeSubmenu);
                    }
                });
            };

            optionsMenu.querySelector('.delete').onclick = (e) => {
                e.stopPropagation();
                const index = Array.from(messageDiv.parentNode.children).indexOf(messageDiv);
                if (index !== -1) {
                    messages.splice(index, 1);
                    messageDiv.remove();
                }
                hideOptionsMenu();
            };
        }

        // Hide options menu when clicking outside
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.message') && !e.target.closest('.message-options')) {
                hideOptionsMenu();
            }
        });

        // Add click listener to message container
        messageContainer.addEventListener('click', handleMessageClick);

        // Profile image and name editing
        const profileImageContainer = document.getElementById('profileImageContainer');
        const profileUpload = document.getElementById('profileUpload');
        const profileImage = document.getElementById('profileImage');
        const profileImageModal = document.getElementById('profileImageModal');
        const profileImageCloseBtn = profileImageModal.querySelector('.picture-modal-close');
        const uploadBtn = document.getElementById('uploadBtn');
        const existingImages = document.getElementById('existingImages');
        const uploadPreview = document.getElementById('uploadPreview');

        // Remove the existing window.addEventListener('load') that clears localStorage
        // and replace with this new initialization code
        window.addEventListener('load', () => {
            // Load saved settings or set defaults
            const savedHeaderName = localStorage.getItem('headerName') || 'John Doe';
            const savedProfileImage = localStorage.getItem('profileImage') || '/static/images/profile_pictures/profile.jpg';
            
            // Set initial values
            document.getElementById('headerName').textContent = savedHeaderName;
            document.getElementById('profileImage').src = savedProfileImage;
            
            // Initialize other components
            loadExistingImages();
            loadBackgroundVideos();
            
            // Load API key and voices if available
            const apiKey = localStorage.getItem('elevenLabsKey');
            if (apiKey) {
                document.getElementById('elevenLabsKey').value = apiKey;
                fetchVoiceIds();
            }
        });

        // Update the saveSettings function
        function saveSettings() {
            const currentName = document.getElementById('headerName').textContent.trim() || 'John Doe';
            const currentImage = document.getElementById('profileImage').src;
            const senderVoice = document.getElementById('senderVoice').value;
            const receiverVoice = document.getElementById('receiverVoice').value;
            
            localStorage.setItem('headerName', currentName);
            localStorage.setItem('profileImage', currentImage);
            localStorage.setItem('senderVoice', senderVoice);
            localStorage.setItem('receiverVoice', receiverVoice);
        }

        // Handle profile image upload preview
        profileUpload.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    uploadPreview.src = e.target.result;
                    uploadPreview.style.display = 'block';
                    uploadBtn.disabled = false;
                };
                reader.readAsDataURL(file);
            } else {
                uploadPreview.style.display = 'none';
                uploadBtn.disabled = true;
            }
        });

        // Open modal and load images
        profileImageContainer.addEventListener('click', () => {
            profileImageModal.style.display = "block";
            loadExistingImages();
            // Reset upload preview
            uploadPreview.style.display = 'none';
            uploadBtn.disabled = true;
            profileUpload.value = '';
        });

        profileImageCloseBtn.addEventListener('click', () => {
            profileImageModal.style.display = "none";
        });

        window.addEventListener('click', (e) => {
            if (e.target === profileImageModal) {
                profileImageModal.style.display = "none";
            }
        });

        // Load existing images
        async function loadExistingImages() {
            try {
                const response = await fetch('/api/profile-pictures');
                const images = await response.json();
                
                existingImages.innerHTML = images.map(image => `
                    <div class="image-item">
                        <img src="/static/images/profile_pictures/${image}" 
                             onclick="selectProfileImage('/static/images/profile_pictures/${image}')"
                             class="${profileImage.src.includes(image) ? 'selected' : ''}">
                    </div>
                `).join('');
            } catch (error) {
                console.error('Error loading existing images:', error);
            }
        }

        // Select existing image
        function selectProfileImage(src) {
            profileImage.src = src;
            localStorage.setItem('profileImage', src);  // Immediately save the profile image
            saveSettings();
            
            // Update selected state in grid
            document.querySelectorAll('.image-grid img').forEach(img => {
                img.classList.toggle('selected', img.src === src);
            });
            
            profileImageModal.style.display = "none";
        }

        // Handle new image upload
        uploadBtn.addEventListener('click', async () => {
            const file = profileUpload.files[0];
            if (!file) {
                alert('Please select a file first');
                return;
            }

            const formData = new FormData();
            formData.append('image', file);

            try {
                const response = await fetch('/api/upload-profile-picture', {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) throw new Error('Upload failed');

                const data = await response.json();
                profileImage.src = data.image_path;
                localStorage.setItem('profileImage', data.image_path);  // Save immediately
                saveSettings();  // Save all settings
                
                // Reset upload preview
                uploadPreview.style.display = 'none';
                uploadBtn.disabled = true;
                profileUpload.value = '';
                
                // Refresh existing images
                await loadExistingImages();
            } catch (error) {
                console.error('Error uploading image:', error);
                alert('Failed to upload image');
            }
        });

        // Handle name editing
        headerName.addEventListener('blur', () => {
            if (!headerName.textContent.trim()) {
                headerName.textContent = 'John Doe';
            }
            saveSettings();
        });

        headerName.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                headerName.blur();
            }
        });

        function createSoundEffectSubmenu(messageDiv) {
            const submenu = document.createElement('div');
            submenu.className = 'sound-effect-submenu';
            
            // Get current effect from the DOM element
            const currentEffect = messageDiv.getAttribute('data-sound-effect') || 'none';

            submenu.innerHTML = `
                <button class="effect-option" data-effect="none">
                    None ${currentEffect === 'none' ? '✓' : ''}
                </button>
                <button class="effect-option" data-effect="vineboom">
                    Vineboom ${currentEffect === 'vineboom' ? '✓' : ''}
                </button>
                <button class="effect-option" data-effect="notification">
                    Notification ${currentEffect === 'notification' ? '✓' : ''}
                </button>
                <button class="effect-option" data-effect="rizz">
                    Rizz ${currentEffect === 'rizz' ? '✓' : ''}
                </button>
                <button class="effect-option" data-effect="send">
                    Send ${currentEffect === 'send' ? '✓' : ''}
                </button>
                <button class="effect-option" data-effect="receive">
                    Receive ${currentEffect === 'receive' ? '✓' : ''}
                </button>
                <button class="effect-option" data-effect="pop">
                    Pop ${currentEffect === 'bleh' ? '✓' : ''}
                </button>
            `;
            return submenu;
        }

        document.querySelectorAll('.preview-video').forEach(video => {
            video.addEventListener('mouseover', function() {
                this.play();
            });
            
            video.addEventListener('mouseout', function() {
                this.pause();
                this.currentTime = 0;
            });
        });

        // Add these functions to handle voice fetching
        let voiceMap = {};

        async function fetchVoiceIds() {
            const apiKey = document.getElementById('elevenLabsKey').value.trim();
            if (!apiKey) {
                alert('Please enter your ElevenLabs API key');
                return;
            }

            try {
                const response = await fetch('/api/fetch-voices', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ apiKey: apiKey })
                });

                if (!response.ok) {
                    throw new Error('Failed to fetch voices');
                }

                const voices = await response.json();
                
                // Clear existing options
                const senderVoice = document.getElementById('senderVoice');
                const receiverVoice = document.getElementById('receiverVoice');
                senderVoice.innerHTML = '<option value="">Select a voice</option>';
                receiverVoice.innerHTML = '<option value="">Select a voice</option>';
                
                // Get saved voice selections
                const savedSenderVoice = localStorage.getItem('senderVoice');
                const savedReceiverVoice = localStorage.getItem('receiverVoice');

                // Populate voice options
                voices.forEach(voice => {
                    // Add to sender dropdown
                    const senderOption = document.createElement('option');
                    senderOption.value = voice.voice_id;
                    senderOption.textContent = voice.name;
                    senderOption.selected = (voice.voice_id === savedSenderVoice);
                    senderVoice.appendChild(senderOption);
                    
                    // Add to receiver dropdown
                    const receiverOption = document.createElement('option');
                    receiverOption.value = voice.voice_id;
                    receiverOption.textContent = voice.name;
                    receiverOption.selected = (voice.voice_id === savedReceiverVoice);
                    receiverVoice.appendChild(receiverOption);
                });

                // Save API key and trigger settings save
                localStorage.setItem('elevenLabsKey', apiKey);
                saveSettings();
                
                alert('Voice IDs successfully fetched!');
            } catch (error) {
                console.error('Error fetching voices:', error);
                alert('Failed to fetch voices. Please check your API key.');
            }
        }

        // Add voice selection event listeners
        document.getElementById('senderVoice').addEventListener('change', saveSettings);
        document.getElementById('receiverVoice').addEventListener('change', saveSettings);

        const importBtn = document.getElementById('importBtn');
        const importJsonModal = document.getElementById('importJsonModal');
        const importJsonCloseBtn = importJsonModal.querySelector('.json-import-modal-close');
        const confirmImport = document.getElementById('confirmImport');
        const jsonInput = document.getElementById('jsonInput');

        importBtn.onclick = () => {
            importJsonModal.style.display = "block";
        }

        importJsonCloseBtn.onclick = () => {
            importJsonModal.style.display = "none";
        }

        window.onclick = (event) => {
            if (event.target == importJsonModal) {
                importJsonModal.style.display = "none";
            }
        }

        confirmImport.onclick = () => {
            const jsonData = jsonInput.value;
            if (!jsonData.trim()) {
                alert('Please enter JSON data');
                return;
            }

            try {
                JSON.parse(jsonData); // Validate JSON
                importFromJSON(jsonData);
                importJsonModal.style.display = "none";
                jsonInput.value = '';
            } catch (error) {
                alert('Invalid JSON format');
            }
        }

        // Update the textarea to use monospace font and format pasted JSON
        jsonInput.addEventListener('paste', (e) => {
            e.preventDefault();
            const paste = e.clipboardData.getData('text');
            try {
                const json = JSON.parse(paste);
                jsonInput.value = JSON.stringify(json, null, 4);
            } catch (error) {
                jsonInput.value = paste;
            }
        });

        // Add this function to load background videos
        async function loadBackgroundVideos() {
            try {
                const response = await fetch('/api/background-videos');
                const videos = await response.json();
                
                const container = document.getElementById('videoPreviewsContainer');
                container.innerHTML = videos.map((video, index) => `
                    <div class="video-option">
                        <video src="/static/videos/${video}" loop muted class="preview-video"></video>
                        <input type="radio" name="background" value="${video}" ${index === 0 ? 'checked' : ''}>
                        <label>${video.replace(/\.[^/.]+$/, "")}</label>
                    </div>
                `).join('');

                // Reattach event listeners for video previews
                document.querySelectorAll('.preview-video').forEach(video => {
                    video.addEventListener('mouseover', function() {
                        this.play();
                    });
                    
                    video.addEventListener('mouseout', function() {
                        this.pause();
                        this.currentTime = 0;
                    });
                });
            } catch (error) {
                console.error('Error loading background videos:', error);
            }
        }

        // Call this function when the page loads
        window.addEventListener('load', () => {
            // ...existing load event code...
            loadBackgroundVideos();
        });

        function updateProgress(percent) {
            const progressBar = document.getElementById('progressBar');
            const progressText = document.getElementById('progressText');
            progressBar.style.width = `${percent}%`;
            progressText.textContent = `${Math.round(percent)}%`;
        }

        function addLog(message, type = 'info') {
            const logContent = document.querySelector('.log-content');
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            entry.innerHTML = `[${new Date().toLocaleTimeString()}] ${message}`;
            logContent.appendChild(entry);
            entry.scrollIntoView({ behavior: 'smooth' });
        }
    </script>
</body>
</html>